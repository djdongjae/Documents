# System Call

### 1. 개요

---

#### 1.1 커널의 역할

커널의 대표적인 기능은 다음과 같다.

* 프로세스 관리
* 메모리 관리
* 네트워크 관리
* 파일 시스템 관리

커널은 위의 기능을 이용하여 유저에게 서비스를 제공하는 역할을 하는데, 이 과정에서 인터페이스를 통해 커널에 접근할 수 있도록 하는 표준화된 포맷이 존재한다. 이 포맷을 `System Call Interface`라고 한다. 한편 커널보다 더 깊이, 즉 하드웨어에 접근하고자 한다면 `Device Driver Interface`를 통해 접근해야 한다. 해당 과제의 목표는 새로운 서비스를 커널에 등록하고 시스템 콜 인터페이스를 조작하여 애플리케이션에서 이를 사용할 수 있도록 하는 것이다.

#### 1.2 인터럽트

우리가 마우스를 움직이거나 키보드에 키를 입력하면 CPU에 인터럽트가 발생한다. 마이크로 프로세서는 본인이 하던 일을 잠시 멈추고 인터럽트 핸들러에 들어가 어떤 인터럽트가 발생했는지 해석하는 과정을 거친 후 다시 본래 하던 일로 돌아간다. 이와 같이 프로세서는 인터럽트를 처리하기 위해 `User Mode`와 `Privileged Mode` 두 가지가 모드를 지닌다. `User Mode`의 경우 일반적으로 유저 프로그램이 사용되는 모드이고 `Privileged Mode`는 입출력과 같이 특수한 이벤트를 처리할 때 사용되는 모드이다.

> ✅ ARM에서 `User Mode`에서 `Privileged Mode`로 전환되기 위해 필요한 인자를 `Exception`이라고 한다. Java에서와 같은 예외가 아닌 **하드웨어적인 예외**이다. 대표적인 예시로 `irq(interupt request)`, `fiq(fast interrupt)`, `undefined(인스트럭션 해석 불가 예외)`등이 있다.

위에서 제시한 인터럽트의 특징은 **예상치 못한 인터럽트**라는 점이다. 이와 달리 **소프트웨어 인터럽트**는 유저가 의도한 바에 따라 예외를 발생시켜 인터럽트를 유도할 수 있는 인터럽트이다. 이와 같은 인터럽트는 대부분 하드웨어적인 I/O를 처리하고자 하는 목적에 의해 유도된다.

커널에서의 **System Call**은 이러한 방식으로 구현되었다. 마이크로 프로세서의 소프트웨어 인터럽트를 활용하여 커널의 서비스를 이용하고 싶을 때 우리는 **System Call Interface**를 통해 이용하게 되는 것이다. 자주 사용하는 System Call에는 파일 시스템 서비스를 활용하는 `Read`, `Write`, `Open`, `Close` 함수 등이 있다.

### 2. System Call 구현

---

#### 2.1 System Call의 동작 구조

`fread()` 함수는 기본적으로 POSIX(Portable Operating System Interface) 라이브러리에 등록되어있다. POSIX 라이브러리는 운영체제 간 호환성을 고려하기 때문에 어떤 플랫폼(윈도우, 리눅스 등)에서도 사용할 수 있다. 

이와 달리 다이렉트 리드는 직접적으로 운영체제에 접근하여 시스템 프로그래밍을 할 때 사용한다. 반면 `fread()`의 경우 스탠다드 라이브러리를 통해 시스템 콜을 호출하게 된다. `fread()` 함수가 존재하는 이유는 **범용성(Portability)** 때문이다. 다이렉트 리드를 통해 시스템 콜을 호출하기 위해서는 운영체제 별로 지원하는 시스템 콜을 따로 공부해야 한다. 반면 `fread()`의 경우 스탠다드 라이브러리가 이를 대신해 준다. 또한 버퍼링과 같은 기능을 지원해 주기도 한다.

앞서 설명했다시피 시스템 콜은 소프트웨어 인터럽트를 발생시킨다. 특정 시스템 콜에 일치하는 소프트웨어 인터럽트를 매칭하기 위해 소프트웨어 인터럽트마다 번호를 부여한다. 마이크로 프로세서는 소프트웨어 인터럽트 발생시 유저 모드에서 특권 모드로 모드를 변경하고 해당 번호에 맞는 핸들러에 따라 특정 함수를 수행한다. 예를 들어 유저가 `fread()` 함수를 호출하여 소프트웨어 인터럽트 발생시 특정 번호에 위치한 `sys_read()` 함수가 이어서 호출된다.

따라서 우리가 System Call을 구현하기 위해서는 우선 **새로운 소프트웨어 인터럽트에 해당하는 번호를 할당 받아야 하고**, 이 번호에 대한 **핸들러를 구현**해 줘야한다. 그리고 이를 애플리케이션에서 사용할 수 있도록 **함수를 구현한다**.

#### 2.2 나만의 System Call 만들기

